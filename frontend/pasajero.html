<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniRiders - Pasajero Premium üë§</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <style>
        /* Estilos espec√≠ficos de la aplicaci√≥n de Pasajero */
        :root {
            --color-rojo-claro: #ff4d4d;
            --color-verde-espoch: #4CAF50;
            --color-azul: #0072ff;
            --color-oro: #FFD700;
        }

        body {
            background: linear-gradient(135deg, #00c6ff, var(--color-azul));
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            height: 100vh;
            color: white;
            text-align: center;
            overflow-y: auto;
            padding: 20px 0;
            transition: background 0.6s ease;
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px; 
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            margin-bottom: 20px;
        }

        /* Mapa Google */
        #map {
            width: 100%;
            height: 320px;
            background-color: #f0f0f0;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
            display: none;
        }
        #map.active {
            display: block;
        }
        #map iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }
        .share-location-wrapper {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: stretch;
        }
        .share-location-wrapper button {
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: var(--color-oro);
            color: #1b1b1b;
            transition: background 0.3s ease;
        }
        .share-location-wrapper button:disabled {
            background: rgba(255, 215, 0, 0.55);
            cursor: not-allowed;
        }
        .share-location-status {
            font-size: 0.85em;
            color: #f5f5f5;
            text-align: left;
        }

        .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .search-form input, .search-form select, .search-btn {
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
        }
        .search-btn {
            background: var(--color-verde-espoch);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        .search-btn:disabled {
            background: #888;
            cursor: not-allowed;
        }
        .message-area {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: 600;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .logout-btn {
            background: white;
            color: var(--color-azul);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 30px;
            transition: 0.3s;
        }
        .profile-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            margin-left: 10px;
            transition: transform 0.3s;
        }

        /* Chat - ESTILOS MEJORADOS */
        .chat-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: left;
            display: none; 
            position: relative;
        }
        .chat-container.active {
            display: block;
        }

        #chatMessages {
            max-height: 200px;
            min-height: 150px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Estilos mejorados para los mensajes del chat */
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
            transition: all 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.self {
            background: rgba(0, 200, 0, 0.2);
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 2px;
            border: 1px solid rgba(0, 200, 0, 0.3);
        }

        .chat-message.other {
            background: rgba(0, 100, 255, 0.2);
            margin-right: auto;
            text-align: left;
            border-bottom-left-radius: 2px;
            border: 1px solid rgba(0, 100, 255, 0.3);
        }

        .chat-message.system {
            background: rgba(255, 193, 7, 0.2) !important;
            border: 1px solid rgba(255, 193, 7, 0.4) !important;
            text-align: center !important;
            margin: 10px auto !important;
            max-width: 90% !important;
            font-style: italic;
        }

        .chat-message .sender-name {
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 3px;
            color: #e0e0e0;
        }

        .chat-message .message-text {
            margin: 5px 0;
            line-height: 1.4;
        }

        .chat-message .message-time {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 3px;
        }

        .message-status {
            font-size: 0.7em;
            color: #4CAF50;
            margin-left: 5px;
        }

        .chat-message.new-message {
            animation: messagePop 0.3s ease-out;
        }

        @keyframes messagePop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Scrollbar personalizado para el chat */
        #chatMessages::-webkit-scrollbar {
            width: 6px;
        }

        #chatMessages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #chatMessages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Indicador de escritura */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 5px 0;
            font-style: italic;
            color: #ccc;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Mensajes r√°pidos */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-reply-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-reply-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input-group input {
            flex-grow: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            outline: none;
            transition: all 0.3s;
        }

        .chat-input-group input:focus {
            border-color: var(--color-verde-espoch);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .chat-input-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .chat-input-group button {
            background: var(--color-verde-espoch);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .chat-input-group button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .chat-input-group button:active {
            transform: translateY(0);
        }

        /* Indicador de conexi√≥n */
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            color: #4CAF50;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .driver-info-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: left;
            color: #eee;
        }

        /* Efectos hover */
        .search-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .logout-btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .profile-btn:hover {
            transform: scale(1.1);
        }

        /* Nuevos estilos para caracter√≠sticas premium */
        .favorite-btn {
            background: none;
            border: none;
            color: var(--color-oro);
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .favorite-btn:hover {
            transform: scale(1.3);
        }

        .favorite-btn.active {
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        .trip-history-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
            text-align: left;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Botones flotantes */
        .floating-btn {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn {
            bottom: 90px;
            right: 20px;
            background: var(--color-verde-espoch);
        }

        .emergency-btn {
            bottom: 160px;
            right: 20px;
            background: var(--color-rojo-claro);
            animation: pulse 2s infinite;
        }

        .history-btn {
            bottom: 230px;
            right: 20px;
            background: var(--color-azul);
        }

        .floating-btn:hover {
            transform: scale(1.1);
        }

        /* Badge de conductor favorito */
        .favorite-badge {
            background: linear-gradient(135deg, var(--color-oro), #FFA500);
            color: #333;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* Bot√≥n para salir del chat */
        .exit-chat-btn {
            background: #666 !important;
            margin-top: 10px;
        }
        .exit-chat-btn:hover {
            background: #777 !important;
        }

        .loyalty-card {
            background: rgba(0, 0, 0, 0.25);
            padding: 18px;
            border-radius: 18px;
            margin-bottom: 18px;
            text-align: left;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
        }

        .loyalty-header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .loyalty-header i {
            font-size: 1.6em;
            color: var(--color-oro);
        }

        .loyalty-progress {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .loyalty-track {
            position: relative;
            height: 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .loyalty-indicator {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 0%;
            background: linear-gradient(90deg, #ffafbd, #ffc3a0);
            border-radius: inherit;
            transition: width 0.6s ease;
        }

        .loyalty-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: rgba(255,255,255,0.8);
        }

        .travel-mood {
            margin-bottom: 18px;
            padding: 16px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.22);
            text-align: left;
        }

        .travel-mood h4 {
            margin-bottom: 10px;
        }

        .mood-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .mood-option {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        .mood-option input {
            display: none;
        }

        .mood-option span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.85em;
            color: rgba(255,255,255,0.85);
            transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
        }

        .mood-option input:checked + span {
            background: linear-gradient(135deg, #ffd166, #f4a261);
            color: #111;
            transform: translateY(-2px);
            border-color: transparent;
            box-shadow: 0 8px 18px rgba(255, 209, 102, 0.35);
        }

        .passenger-highlights {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .highlight-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .highlight-card i {
            font-size: 1.3em;
            color: var(--color-oro);
        }

        .highlight-card strong {
            display: block;
            font-size: 1.1em;
        }

        .highlight-card span {
            font-size: 0.75em;
            color: rgba(255,255,255,0.7);
        }

        .body-note {
            font-size: 0.75em;
            color: rgba(255,255,255,0.65);
            margin-top: 6px;
        }

        body.dark-mode .loyalty-card,
        body.dark-mode .travel-mood,
        body.dark-mode .passenger-highlights .highlight-card {
            background: rgba(25, 25, 25, 0.6);
            border-color: rgba(255, 255, 255, 0.08);
        }

        body.dark-mode .mood-option span {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.85);
        }

        body.dark-mode .mood-option input:checked + span {
            color: #111;
        }

    </style>
</head>
<body>
    <button class="theme-toggle" type="button" data-theme-toggle aria-label="Cambiar modo visual"></button>
    <div class="floating-illustration" aria-hidden="true">
        <i class="fas fa-motorcycle"></i>
    </div>
    <span class="animated-ripple" style="width: 280px; height: 280px; right: 10%; top: 18%;"></span>
    <span class="animated-ripple" style="width: 180px; height: 180px; right: 6%; top: 30%; animation-delay: 5s;"></span>

    <!-- Botones flotantes -->
    <button class="floating-btn voice-btn" onclick="toggleVoiceRecognition()">üé§</button>
    <button class="floating-btn emergency-btn" onclick="handleEmergency()">üÜò</button>
    <button class="floating-btn history-btn" onclick="showTripHistory()">üìã</button>

    <div class="particles"></div>
    <div class="main-panel" id="requestPanel">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="passengerProfilePic" src="/img/default_avatar.jpg" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; object-fit: cover;">
                <div>
                    <h1 style="margin: 0;">Hola, <span id="userNameDisplay">Pasajero</span>! üëã</h1>
                    <p class="role-text" style="margin: 0; font-size: 0.9em;">
                        Pasajero Premium UniRiders
                        <span class="achievement-badge" style="background: var(--color-oro); color: #333; padding: 2px 6px; border-radius: 8px; font-size: 0.7em; margin-left: 5px;">‚≠ê 4.9</span>
                    </p>
                </div>
            </div>
            <button class="profile-btn">‚öôÔ∏è</button>
        </div>

        <div class="loyalty-card glass-effect" id="loyaltyCard">
            <div class="loyalty-header">
                <i class="fas fa-medal"></i>
                <div>
                    <strong>Progreso Rider</strong>
                    <span class="body-note" id="loyaltyTagline">Tus pr√≥ximos viajes desbloquean sorpresas.</span>
                </div>
            </div>
            <div class="loyalty-progress">
                <div class="loyalty-track">
                    <span class="loyalty-indicator" id="loyaltyProgressIndicator"></span>
                </div>
                <div class="loyalty-meta">
                    <span>Viajes completados</span>
                    <span id="loyaltyTrips">0</span>/8
                </div>
            </div>
        </div>

        <div class="passenger-highlights" id="passengerHighlights">
            <div class="highlight-card">
                <i class="fas fa-motorcycle"></i>
                <div>
                    <strong id="activeDriversCount">--</strong>
                    <span>Motos activas cerca</span>
                </div>
            </div>
            <div class="highlight-card">
                <i class="fas fa-shield-heart"></i>
                <div>
                    <strong id="safetyScore">100%</strong>
                    <span>Seguridad en los √∫ltimos viajes</span>
                </div>
            </div>
        </div>

        <div class="travel-mood glass-effect" id="travelMood">
            <h4>üé∂ Viaje con estilo</h4>
            <div class="mood-options">
                <label class="mood-option">
                    <input type="checkbox" value="chill" id="moodChill">
                    <span><i class="fas fa-music"></i> Chill</span>
                </label>
                <label class="mood-option">
                    <input type="checkbox" value="express" id="moodExpress">
                    <span><i class="fas fa-bolt"></i> Express</span>
                </label>
                <label class="mood-option">
                    <input type="checkbox" value="eco" id="moodEco">
                    <span><i class="fas fa-leaf"></i> Eco</span>
                </label>
            </div>
        </div>

        <!-- Panel de historial de viajes -->
        <div class="trip-history-panel" id="tripHistoryPanel" style="display: none;">
            <h4>üìã Mis √öltimos Viajes</h4>
            <div id="historyList">
                <div class="history-item">
                    <div>
                        <strong>ESPOCH ‚Üí Terminal</strong>
                        <div style="font-size: 0.8em; color: #ccc;">Cargando...</div>
                    </div>
                    <div class="rating-stars" style="color: var(--color-oro);">-----</div>
                </div>
            </div>
        </div>

        <div class="search-form">
            <input type="text" id="origen" placeholder="üìç Origen (Ej: Sede Centro)">
            <input type="text" id="destino" placeholder="üèÅ Destino (Ej: Sede Norte)">
            <select id="paymentMethod">
                <option value="Efectivo">Efectivo üíµ</option>
                <option value="Tarjeta">Transferencia üí≥</option>
            </select>
            <button class="search-btn" id="requestRideBtn">üöÄ Solicitar Viaje Premium</button>
        </div>

        <div class="message-area" id="messageArea">
            üí´ Ingresa tu destino y viaja con los mejores conductores
        </div>
    </div>

    <div id="activeTripPanel" class="main-panel" style="display: none; padding-top: 0; margin-top: 20px; max-width: 500px;">
        <div class="connection-status">
            <div class="connection-dot"></div>
            <span>Conectado</span>
        </div>
        
        <h3 style="margin-bottom: 15px;">üèçÔ∏è Tu Viaje Activo</h3>
        
        <div class="driver-info-panel">
            <h4>
                Conductor: <span id="activeTripDriverName"></span>
                <button class="favorite-btn" id="favoriteBtn" onclick="toggleFavorite()">‚≠ê</button>
                <span class="favorite-badge" id="favoriteBadge" style="display: none;">Favorito</span>
            </h4>
            <p>üìç De: <strong id="activeTripOriginDisplay"></strong></p>
            <p>üèÅ A: <strong id="activeTripDestinationDisplay"></strong></p>
            <p>‚è±Ô∏è Tiempo estimado: <strong id="passengerEstimatedTime">15 min</strong></p>
            <p>üí∞ Precio estimado: <strong id="estimatedPrice">$3.50</strong></p>
        </div>

        <div id="map" class="active">
            <iframe id="mapFrame" title="Mapa del viaje" loading="lazy" allowfullscreen></iframe>
        </div>
        <p style="margin-top: 10px; font-size: 0.9em;">Conductor: <span id="driverMapCoords"></span></p>
        <div class="share-location-wrapper" id="shareLocationContainer" style="display: none;">
            <button id="shareLocationBtn">üìç Enviar mi ubicaci√≥n actual al conductor</button>
            <span class="share-location-status" id="passengerLocationStatus">Tu ubicaci√≥n ayuda al conductor a encontrarte m√°s r√°pido.</span>
        </div>

        <div class="chat-container active">
            <h4>üí¨ Chat con Conductor</h4>
            <div id="chatMessages"></div>
            <div class="chat-input-group">
                <input type="text" id="chatInput" placeholder="Escribe un mensaje...">
                <button id="sendChatBtn">Enviar</button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="search-btn" style="background: var(--color-verde-espoch); flex: 1;" onclick="shareTrip()">
                üì§ Compartir Viaje
            </button>
            <button class="search-btn" style="background: var(--color-rojo-claro); flex: 1;" onclick="cancelTrip()">
                ‚ùå Cancelar Viaje
            </button>
        </div>
        
        <!-- NUEVO BOT√ìN PARA SALIR DEL CHAT -->
        <button class="search-btn exit-chat-btn" onclick="exitChat()">
            üëã Salir del Chat
        </button>
    </div>

    <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>

    <div id="toast" class="toast"></div>

    <script src="theme.js"></script>
    <script>
        const API = "http://localhost:3000/api";
        
        // OBTENER DATOS CON SISTEMA DE SESIONES
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('sessionId') || localStorage.getItem('currentSessionId');
        const userName = localStorage.getItem(sessionId + '_userName') || 'Pasajero';
        const userEmail = localStorage.getItem(sessionId + '_userEmail');
        const userRole = localStorage.getItem(sessionId + '_userRole');

        document.getElementById('userNameDisplay').innerText = userName.split(' ')[0]; 
        
        const requestPanel = document.getElementById('requestPanel');
        const activeTripPanel = document.getElementById('activeTripPanel');
        const requestRideBtn = document.getElementById('requestRideBtn');
        const messageArea = document.getElementById('messageArea');
        const mapElement = document.getElementById('map');
        const mapFrame = document.getElementById('mapFrame');
        const driverMapCoords = document.getElementById('driverMapCoords');
        const shareLocationContainer = document.getElementById('shareLocationContainer');
        const shareLocationBtn = document.getElementById('shareLocationBtn');
        const passengerLocationStatus = document.getElementById('passengerLocationStatus');
        let currentTripId = null;
        const loyaltyProgressIndicator = document.getElementById('loyaltyProgressIndicator');
        const loyaltyTripsLabel = document.getElementById('loyaltyTrips');
        const loyaltyTagline = document.getElementById('loyaltyTagline');
        const activeDriversCountEl = document.getElementById('activeDriversCount');
        const safetyScoreEl = document.getElementById('safetyScore');
        const moodInputs = document.querySelectorAll('#travelMood input[type="checkbox"]');

        const moodStorageKey = userEmail ? `passengerMood_${userEmail}` : 'passengerMood_guest';
        let selectedMoods = new Set();

        try {
            const storedMoods = JSON.parse(localStorage.getItem(moodStorageKey) || '[]');
            if (Array.isArray(storedMoods)) {
                selectedMoods = new Set(storedMoods);
            }
        } catch (error) {
            console.warn('No se pudieron cargar moods previos', error);
        }

        function persistMoods() {
            localStorage.setItem(moodStorageKey, JSON.stringify(Array.from(selectedMoods)));
        }

        function updateMoodMessage(force = false) {
            if (!messageArea) return;
            if (currentTripId && !force) return;

            let baseMessage = 'üí´ Ingresa tu destino y viaja con los mejores conductores';
            if (selectedMoods.has('express')) {
                baseMessage = '‚ö° Indica tu destino y prep√°rate para llegar a tiempo.';
            } else if (selectedMoods.has('chill')) {
                baseMessage = 'üéß ¬øDestino listo? Rel√°jate, nosotros te llevamos.';
            } else if (selectedMoods.has('eco')) {
                baseMessage = 'üå± Comparte tu ruta y reduce tu huella de carbono hoy mismo.';
            }
            messageArea.innerText = baseMessage;
        }

        moodInputs.forEach((input) => {
            if (selectedMoods.has(input.value)) {
                input.checked = true;
            }
            input.addEventListener('change', () => {
                if (input.checked) {
                    selectedMoods.add(input.value);
                } else {
                    selectedMoods.delete(input.value);
                }
                persistMoods();
                updateMoodMessage();
            });
        });

        updateMoodMessage();

        function updateLoyaltyProgress(completedTrips = 0) {
            if (!loyaltyProgressIndicator || !loyaltyTripsLabel || !loyaltyTagline) return;

            const target = 8;
            const progress = Math.min(completedTrips, target);
            const percentage = Math.min((progress / target) * 100, 100);

            loyaltyProgressIndicator.style.width = `${percentage}%`;
            loyaltyTripsLabel.textContent = completedTrips;
            if (progress >= target) {
                loyaltyTagline.textContent = '¬°Insignia desbloqueada! Disfruta tus beneficios.';
            } else {
                loyaltyTagline.textContent = `Te faltan ${Math.max(target - progress, 1)} viajes para la pr√≥xima recompensa.`;
            }
        }

        async function updateStatsSnapshot(signal) {
            if (!API) return;

            try {
                const res = await fetch(`${API}/stats/overview`, { signal });
                if (!res.ok) return;
                const stats = await res.json();

                if (activeDriversCountEl) {
                    const computedDrivers = Math.max(Number(stats.activeTrips || 0) * 2, Number(stats.activeUsers || 0));
                    activeDriversCountEl.textContent = Math.max(computedDrivers, 8);
                }

                if (safetyScoreEl) {
                    const base = Number(stats.completedTrips || 0);
                    const safeScore = Math.min(100, 92 + (base % 8));
                    safetyScoreEl.textContent = `${safeScore}%`;
                }

            } catch (error) {
                if (activeDriversCountEl && activeDriversCountEl.textContent === '--') {
                    activeDriversCountEl.textContent = '12';
                }
            }
        }

        updateLoyaltyProgress(0);

        const statsController = new AbortController();
        updateStatsSnapshot(statsController.signal);
        const statsInterval = setInterval(() => updateStatsSnapshot(statsController.signal), 15000);

        window.addEventListener('beforeunload', () => {
            statsController.abort();
            clearInterval(statsInterval);
        });

        let pollingStatusInterval = null;
        let currentChatInterval = null;
        let driverLocationPolling = null;
        let currentDriverName = null;
        let lastDriverLocation = null;
        let passengerSharedLocation = null;
        let typingTimeout = null;
        let isTyping = false;
        let voiceRecognition = null;
        let favoriteDrivers = JSON.parse(localStorage.getItem('favorite_drivers') || '{}');

        if (shareLocationBtn) {
            shareLocationBtn.addEventListener('click', shareCurrentLocation);
        }

        // =============================================
        // FUNCIONALIDADES MEJORADAS PARA PASAJEROS
        // =============================================

        // Funci√≥n mejorada para cargar historial de viajes del pasajero
        async function loadPassengerTripHistory() {
            try {
                const res = await fetch(`${API}/trips/history`, {
                    headers: {
                        'user-email': userEmail,
                        'user-role': userRole,
                        'session-id': sessionId
                    }
                });
                
                const history = await res.json();
                const historyList = document.getElementById('historyList');

                if (history.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; color: #ccc; padding: 20px;">No hay viajes anteriores</div>';
                    updateLoyaltyProgress(0);
                    return;
                }

                historyList.innerHTML = '';
                history.forEach(trip => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const stars = trip.calificacion_conductor ? 
                        '‚òÖ'.repeat(trip.calificacion_conductor) + '‚òÜ'.repeat(5 - trip.calificacion_conductor) : 
                        '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ';
                    
                    const tripDate = new Date(trip.fecha_solicitud);
                    const formattedDate = tripDate.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    historyItem.innerHTML = `
                        <div>
                            <strong>${trip.origen} ‚Üí ${trip.destino}</strong>
                            <div style="font-size: 0.8em; color: #ccc;">
                                ${formattedDate}
                                ${trip.estado === 'COMPLETADO' ? ' - Completado' : ' - En curso'}
                                ${trip.costo ? ` - $${trip.costo}` : ''}
                            </div>
                        </div>
                        <div class="rating-stars" style="color: var(--color-oro);">${stars}</div>
                    `;
                    
                    historyList.appendChild(historyItem);
                });

                updateLoyaltyProgress(history.length);

            } catch (error) {
                console.error('Error cargando historial:', error);
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '<div style="text-align: center; color: #ccc; padding: 20px;">Error cargando historial</div>';
            }
        }

        // Funci√≥n mejorada para mostrar historial de viajes
        function showTripHistory() {
            // Redirigir a la p√°gina central de historial con la sesi√≥n actual
            window.location.href = `trip-history.html?sessionId=${sessionId}`;
        }

        // Funci√≥n para salir del chat cuando el viaje finaliza
        function exitChat() {
            if (confirm("¬øSalir del chat? Podr√°s ver el historial completo m√°s tarde.")) {
                resetUI();
                showToast('Chat cerrado. El historial se guard√≥ correctamente.', true);
            }
        }

        // Sistema de comandos de voz
        function setupVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognition = new SpeechRecognition();
                voiceRecognition.continuous = false;
                voiceRecognition.lang = 'es-ES';
                voiceRecognition.interimResults = false;

                voiceRecognition.onresult = (event) => {
                    const command = event.results[0][0].transcript.toLowerCase();
                    handleVoiceCommand(command);
                };

                voiceRecognition.onerror = (event) => {
                    console.log('Error en reconocimiento de voz:', event.error);
                };
            }
        }

        function toggleVoiceRecognition() {
            if (voiceRecognition) {
                try {
                    voiceRecognition.start();
                    showToast('üé§ Escuchando... Di "solicitar viaje" o "cancelar viaje"', true);
                    
                    setTimeout(() => {
                        if (voiceRecognition) {
                            voiceRecognition.stop();
                        }
                    }, 5000);
                } catch (error) {
                    showToast('‚ùå Error al activar el micr√≥fono', false);
                }
            } else {
                showToast('‚ùå Reconocimiento de voz no disponible', false);
            }
        }

        function handleVoiceCommand(command) {
            console.log('Comando de voz:', command);
            
            if (command.includes('solicitar viaje') || command.includes('pedir viaje')) {
                if (!currentTripId) {
                    requestRideBtn.click();
                    showToast('‚úÖ Viaje solicitado por voz', true);
                }
            } else if (command.includes('cancelar viaje') || command.includes('cancelar')) {
                if (currentTripId) {
                    cancelTrip();
                    showToast('‚úÖ Viaje cancelado por voz', true);
                }
            } else if (command.includes('compartir viaje') || command.includes('compartir')) {
                shareTrip();
            } else if (command.includes('historial') || command.includes('mis viajes')) {
                showTripHistory();
            } else if (command.includes('salir chat') || command.includes('salir')) {
                exitChat();
            } else {
                showToast('‚ùå Comando no reconocido: ' + command, false);
            }
        }

        // Bot√≥n de emergencia
        function handleEmergency() {
            if (confirm('üö® ¬øEST√ÅS EN UNA SITUACI√ìN DE EMERGENCIA?\n\nSe enviar√° tu ubicaci√≥n a los contactos de emergencia y se notificar√° a las autoridades.')) {
                const location = { lat: -1.65, lng: -78.68 }; // Ubicaci√≥n simulada
                
                fetch(`${API}/emergency/alert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userEmail: userEmail,
                        location: location,
                        message: 'Alerta de emergencia desde la app UniRiders - Pasajero',
                        tripId: currentTripId
                    })
                }).then(res => res.json().catch(() => ({}))).then(data => {
                    const message = data && data.message ? data.message : 'üö® Alerta de emergencia enviada';
                    showToast(message, false);

                    if (navigator.vibrate) {
                        navigator.vibrate([500, 200, 500, 200, 500]);
                    }

                    if (data && Array.isArray(data.contacts) && data.contacts.length > 0) {
                        const whatsappContact = data.contacts.find(c => c.whatsappLink);
                        const summary = data.contacts
                            .filter(c => c.phone)
                            .map(c => `${c.name || c.email}: ${c.phone}`)
                            .join('\n');

                        if (summary) {
                            alert(`Contactos de emergencia notificados:\n${summary}`);
                        }

                        if (whatsappContact && whatsappContact.whatsappLink) {
                            window.open(whatsappContact.whatsappLink, '_blank');
                        }
                    }
                }).catch(error => {
                    showToast('‚úÖ Alerta enviada (modo offline)', false);
                });
            }
        }

        // Sistema de favoritos
        function toggleFavorite() {
            const driverName = document.getElementById('activeTripDriverName').textContent;
            const favoriteBtn = document.getElementById('favoriteBtn');
            const favoriteBadge = document.getElementById('favoriteBadge');
            
            if (favoriteDrivers[driverName]) {
                delete favoriteDrivers[driverName];
                favoriteBtn.style.color = '#ccc';
                favoriteBadge.style.display = 'none';
                showToast(`‚ùå ${driverName} removido de favoritos`, true);
            } else {
                favoriteDrivers[driverName] = true;
                favoriteBtn.style.color = 'var(--color-oro)';
                favoriteBadge.style.display = 'inline';
                favoriteBtn.classList.add('active');
                setTimeout(() => favoriteBtn.classList.remove('active'), 500);
                showToast(`‚≠ê ${driverName} agregado a favoritos`, true);
            }
            
            localStorage.setItem('favorite_drivers', JSON.stringify(favoriteDrivers));
        }

        // Compartir viaje
        function shareTrip() {
            const tripDetails = {
                origin: document.getElementById('activeTripOriginDisplay').textContent,
                destination: document.getElementById('activeTripDestinationDisplay').textContent,
                driver: document.getElementById('activeTripDriverName').textContent,
                estimatedTime: document.getElementById('passengerEstimatedTime').textContent
            };
            
            const shareText = `üèçÔ∏è Estoy viajando con UniRiders\nüìç De: ${tripDetails.origin}\nüèÅ A: ${tripDetails.destination}\nüë§ Conductor: ${tripDetails.driver}\n‚è±Ô∏è Llegada: ${tripDetails.estimatedTime}\n\n#UniRiders #ViajeSeguro`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Mi viaje UniRiders',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('‚úÖ Informaci√≥n del viaje copiada al portapapeles', true);
                });
            }
        }

        // Sistema de calificaciones para pasajeros
        function showPassengerRatingModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; color: #333;">
                    <h3>‚≠ê Califica a tu conductor</h3>
                    <p>¬øC√≥mo fue tu experiencia con <strong>${currentDriverName || 'el conductor'}</strong>?</p>
                    <div class="star-rating" style="font-size: 2em; margin: 20px 0;">
                        ${'‚òÖ'.repeat(5).split('').map((star, i) => 
                            `<span style="color: #ccc; cursor: pointer; transition: color 0.3s;" 
                                  onmouseover="highlightPassengerStars(this, ${i})" 
                                  onclick="submitDriverRating(${i + 1})">${star}</span>`
                        ).join('')}
                    </div>
                    <textarea id="driverRatingComment" placeholder="¬øAlg√∫n comentario sobre el viaje?" 
                              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; resize: vertical;"></textarea>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="skipDriverRating()" 
                                style="background: #ccc; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
                            Saltar
                        </button>
                        <button onclick="submitDriverRating()" 
                                style="background: var(--color-verde-espoch); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
                            Enviar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.highlightPassengerStars = (element, index) => {
                const stars = element.parentElement.children;
                for (let i = 0; i < stars.length; i++) {
                    stars[i].style.color = i <= index ? '#FFD700' : '#ccc';
                }
            };
        }

        function submitDriverRating(rating = 0) {
            const comment = document.getElementById('driverRatingComment')?.value || '';
            
            if (currentTripId) {
                fetch(`${API}/trips/${currentTripId}/rate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rating: rating,
                        comment: comment,
                        ratedBy: 'passenger'
                    })
                }).then(() => {
                    showToast('‚≠ê Calificaci√≥n enviada. ¬°Gracias!', true);
                });
            }
            
            document.querySelector('div[style*="position: fixed"]')?.remove();
        }

        function skipDriverRating() {
            document.querySelector('div[style*="position: fixed"]')?.remove();
        }

        // =============================================
        // C√ìDIGO EXISTENTE (MEJORADO)
        // =============================================

        // Cargar foto de perfil desde la base de datos
        function loadPassengerProfilePhoto() {
            const passengerProfilePic = document.getElementById('passengerProfilePic');
            
            if (userEmail && passengerProfilePic) {
                const timestamp = new Date().getTime();
                passengerProfilePic.src = `http://localhost:3000/api/profile/${userEmail}/photo?t=${timestamp}`;
            }
        }

        // Navegaci√≥n al perfil
        document.querySelector('.profile-btn').onclick = () => {
             window.location.href = `profile.html?role=${userRole}&email=${userEmail}&sessionId=${sessionId}`;
        };

        // Cerrar sesi√≥n
        async function logout() {
            try {
                await fetch(`${API}/logout`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'user-email': userEmail,
                        'session-id': sessionId
                    }
                });
            } catch (error) {
                console.log('Error al cerrar sesi√≥n en servidor:', error);
            }
            
            // Limpiar datos de esta sesi√≥n
            if (sessionId) {
                localStorage.removeItem(sessionId + '_userEmail');
                localStorage.removeItem(sessionId + '_userName');
                localStorage.removeItem(sessionId + '_userRole');
                localStorage.removeItem('currentSessionId');
            }
            
            window.location.href = 'Index.html';
        }

        // L√≥gica de Google Maps embebido
        function initMap() {
            if (mapFrame) {
                mapFrame.src = buildGoogleMapsUrl({ lat: -1.65, lon: -78.68 });
            }
        }

        function buildGoogleMapsUrl(pointA, pointB) {
            const baseUrl = 'https://maps.google.com/maps';
            const params = new URLSearchParams({
                hl: 'es',
                t: 'm',
                z: pointA && pointB ? '14' : '15',
                output: 'embed'
            });

            if (pointA && pointB) {
                params.set('f', 'd');
                params.set('source', 's_d');
                params.set('saddr', `${pointA.lat},${pointA.lon}`);
                params.set('daddr', `${pointB.lat},${pointB.lon}`);
            } else if (pointA) {
                params.set('q', `${pointA.lat},${pointA.lon}`);
            }

            return `${baseUrl}?${params.toString()}`;
        }

        function updateMapEmbed() {
            if (!mapFrame) return;

            if (lastDriverLocation && passengerSharedLocation) {
                mapFrame.src = buildGoogleMapsUrl(lastDriverLocation, passengerSharedLocation);
            } else if (lastDriverLocation) {
                mapFrame.src = buildGoogleMapsUrl(lastDriverLocation);
            } else if (passengerSharedLocation) {
                mapFrame.src = buildGoogleMapsUrl(passengerSharedLocation);
            }
        }

        function shareCurrentLocation() {
            if (!currentTripId) {
                showToast('Solicita un viaje antes de compartir tu ubicaci√≥n.', false);
                return;
            }

            if (!navigator.geolocation) {
                showToast('Tu dispositivo no soporta geolocalizaci√≥n autom√°tica.', false);
                return;
            }

            shareLocationBtn.disabled = true;
            passengerLocationStatus.innerText = 'Obteniendo tu ubicaci√≥n actual...';

            navigator.geolocation.getCurrentPosition(async position => {
                const coords = {
                    lat: parseFloat(position.coords.latitude.toFixed(5)),
                    lon: parseFloat(position.coords.longitude.toFixed(5))
                };

                passengerSharedLocation = coords;
                passengerLocationStatus.innerText = `Ubicaci√≥n enviada: Lat ${coords.lat}, Lon ${coords.lon}`;
                updateMapEmbed();

                try {
                    await fetch(`${API}/trips/${currentTripId}/passengerLocation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'user-email': userEmail || '',
                            'session-id': sessionId || ''
                        },
                        body: JSON.stringify(coords)
                    });
                    showToast('Ubicaci√≥n compartida con el conductor ‚úÖ', true);
                } catch (error) {
                    console.error('Error al compartir ubicaci√≥n:', error);
                    showToast('No se pudo enviar tu ubicaci√≥n. Intenta nuevamente.', false);
                } finally {
                    shareLocationBtn.disabled = false;
                }
            }, error => {
                shareLocationBtn.disabled = false;

                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        passengerLocationStatus.innerText = 'Permiso denegado. Habilita la ubicaci√≥n para compartirla.';
                        showToast('Necesitamos tu permiso de ubicaci√≥n para compartirla con el conductor.', false);
                        break;
                    case error.POSITION_UNAVAILABLE:
                        passengerLocationStatus.innerText = 'Se√±al GPS no disponible. Int√©ntalo m√°s tarde.';
                        showToast('No fue posible obtener tu ubicaci√≥n actual.', false);
                        break;
                    case error.TIMEOUT:
                        passengerLocationStatus.innerText = 'Tiempo de espera agotado. Vuelve a intentarlo.';
                        showToast('El GPS tard√≥ demasiado en responder.', false);
                        break;
                    default:
                        passengerLocationStatus.innerText = 'No se pudo acceder a tu ubicaci√≥n. Vuelve a intentarlo.';
                        showToast('Error desconocido al obtener tu ubicaci√≥n.', false);
                        break;
                }
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        }

        // L√≥gica de solicitud de viaje y estado (polling)
        async function checkTripStatus() {
            if (!currentTripId) return;

            try {
                const res = await fetch(`${API}/trips/${currentTripId}/status`, {
                    headers: {
                        'user-email': userEmail,
                        'session-id': sessionId
                    }
                });
                const data = await res.json();

                if (data.status === 'ACEPTADO') {
                    clearInterval(pollingStatusInterval);
                    pollingStatusInterval = null;

                    requestPanel.style.display = 'none'; 
                    activeTripPanel.style.display = 'block'; 
                    mapElement.classList.add('active'); 
                    
                    currentDriverName = data.driver;
                    document.getElementById('activeTripDriverName').innerText = currentDriverName;
                    document.getElementById('activeTripOriginDisplay').innerText = document.getElementById('origen').value;
                    document.getElementById('activeTripDestinationDisplay').innerText = document.getElementById('destino').value;

                    // Verificar si el conductor es favorito
                    const favoriteBtn = document.getElementById('favoriteBtn');
                    const favoriteBadge = document.getElementById('favoriteBadge');
                    if (favoriteDrivers[currentDriverName]) {
                        favoriteBtn.style.color = 'var(--color-oro)';
                        favoriteBadge.style.display = 'inline';
                    }

                    shareLocationContainer.style.display = 'flex';
                    if (shareLocationBtn) {
                        shareLocationBtn.disabled = false;
                        passengerLocationStatus.innerText = 'Env√≠a tu ubicaci√≥n para que el conductor pueda navegar hacia ti.';
                    }
                    updateMapEmbed();
                    startChatSession(currentTripId);
                    startDriverLocationPolling(currentTripId);

                } else if (data.status === 'PENDIENTE') {
                    messageArea.innerText = "üîÑ Esperando que un conductor acepte la oferta...";
                } else if (data.status === 'FINALIZADO') {
                    // VIAJE FINALIZADO AUTOM√ÅTICAMENTE
                    clearInterval(pollingStatusInterval);
                    pollingStatusInterval = null;
                    
                    showToast("üèÅ Viaje finalizado por el conductor", true);
                    
                    // Mostrar modal de calificaci√≥n
                    setTimeout(() => {
                        showPassengerRatingModal();
                    }, 1000);
                    
                    // Limpiar recursos
                    if (driverLocationPolling) clearInterval(driverLocationPolling);
                    if (currentChatInterval) clearInterval(currentChatInterval);
                    
                    // Resetear UI
                    resetUI();
                }
            } catch (error) {
                console.error("Error al consultar estado:", error);
            }
        }

        async function startDriverLocationPolling(tripId) {
            driverLocationPolling = setInterval(async () => {
                try {
                    const res = await fetch(`${API}/trips/${tripId}/driverLocation`, {
                        headers: {
                            'user-email': userEmail,
                            'session-id': sessionId
                        }
                    });
                    const data = await res.json();
                    
                    if (data && data.lat && data.lon) {
                        lastDriverLocation = {
                            lat: parseFloat(data.lat),
                            lon: parseFloat(data.lon)
                        };
                        driverMapCoords.innerText = `Lat: ${Number(data.lat).toFixed(5)}, Lon: ${Number(data.lon).toFixed(5)}`;
                        updateMapEmbed();
                    }
                } catch (error) {
                    console.error("Error al obtener ubicaci√≥n del conductor:", error);
                }
            }, 3000); 
        }

        requestRideBtn.addEventListener('click', async () => {
            const origin = document.getElementById('origen').value.trim();
            const destination = document.getElementById('destino').value.trim();
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!origin || !destination) {
                messageArea.innerText = "üö® Ingresa origen y destino.";
                return;
            }

            requestRideBtn.disabled = true;
            requestRideBtn.innerText = 'Enviando solicitud...';

            try {
                const res = await fetch(`${API}/trips/request`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'user-email': userEmail,
                        'session-id': sessionId
                    },
                    body: JSON.stringify({ 
                        passengerName: userName, 
                        passengerEmail: userEmail,
                        origin, 
                        destination, 
                        paymentMethod 
                    })
                });
                const data = await res.json();
                
                currentTripId = data.tripId;
                
                messageArea.innerText = data.message;
                requestRideBtn.innerText = 'Buscando conductor... üîÑ';
                pollingStatusInterval = setInterval(checkTripStatus, 4000); 

            } catch (error) {
                messageArea.innerText = "‚ùå Error al solicitar el viaje.";
                requestRideBtn.disabled = false;
                requestRideBtn.innerText = 'Solicitar Viaje üöÄ';
            }
        });

        // Resetear UI y limpiar recursos
        function resetUI() {
            currentTripId = null;
            currentDriverName = null;
            lastDriverLocation = null;
            passengerSharedLocation = null;
            if (pollingStatusInterval) clearInterval(pollingStatusInterval);
            if (currentChatInterval) clearInterval(currentChatInterval);
            if (driverLocationPolling) clearInterval(driverLocationPolling);

            requestPanel.style.display = 'block';
            activeTripPanel.style.display = 'none';
            mapElement.classList.remove('active');
            requestRideBtn.disabled = false;
            requestRideBtn.innerText = 'Solicitar Viaje üöÄ';
            messageArea.innerText = 'üí´ Ingresa tu destino y viaja con los mejores conductores';
            updateMoodMessage(true);
            shareLocationContainer.style.display = 'none';
            if (shareLocationBtn) {
                shareLocationBtn.disabled = false;
                passengerLocationStatus.innerText = 'Tu ubicaci√≥n ayuda al conductor a encontrarte m√°s r√°pido.';
            }
            if (mapFrame) {
                mapFrame.src = buildGoogleMapsUrl({ lat: -1.65, lon: -78.68 });
            }
        }

        // Cancelar viaje con confirmaci√≥n y limpieza de chat
        function cancelTrip(isFinalized = false) {
            if (isFinalized) {
                // Mostrar modal de calificaci√≥n cuando el conductor finaliza
                setTimeout(() => {
                    showPassengerRatingModal();
                }, 1000);
                
                // Limpiar chat cuando el conductor finaliza el viaje
                if (currentTripId) {
                    fetch(`${API}/chat/${currentTripId}/clear`, {
                        method: 'POST'
                    }).catch(err => console.error('Error limpiando chat:', err));
                }
                alert("¬°El conductor ha finalizado el viaje!");
                resetUI();
            } else if (confirm("¬øEst√°s seguro de que quieres cancelar el viaje?")) {
                // Limpiar chat al cancelar
                if (currentTripId) {
                    fetch(`${API}/chat/${currentTripId}/clear`, {
                        method: 'POST'
                    }).catch(err => console.error('Error limpiando chat:', err));
                }
                
                // Cancelar viaje en el servidor
                fetch(`${API}/trips/cancel`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'user-email': userEmail,
                        'session-id': sessionId
                    },
                    body: JSON.stringify({ tripId: currentTripId })
                }).catch(err => console.error('Error cancelando viaje:', err));
                
                alert("Viaje cancelado.");
                resetUI();
            }
        }
        window.cancelTrip = cancelTrip;

        // L√≥gica de chat mejorada
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatMessagesDiv = document.getElementById('chatMessages');

        function startChatSession(tripId) {
            console.log("üü° Pasajero iniciando sesi√≥n de chat para viaje:", tripId);
            
            document.querySelector('.chat-container').classList.add('active');
            
            const fetchMessages = async () => {
                try {
                    const [messagesRes, typingRes] = await Promise.all([
                        fetch(`${API}/chat/${tripId}/messages`),
                        fetch(`${API}/chat/${tripId}/typing`)
                    ]);
                    
                    if (!messagesRes.ok) throw new Error('Error en respuesta del servidor');
                    
                    const messages = await messagesRes.json();
                    const typingData = await typingRes.json();
                    
                    updateChatMessages(messages);
                    updateTypingIndicator(typingData.typing);
                    
                } catch (error) {
                    console.log("‚ö†Ô∏è Error al obtener mensajes:", error);
                }
            };

            const updateChatMessages = (messages) => {
                chatMessagesDiv.innerHTML = '';
                messages.forEach(msg => {
                    const msgElement = document.createElement('div');
                    msgElement.classList.add('chat-message');
                    msgElement.setAttribute('data-message-id', msg.messageId || msg.timestamp);
                    
                    const isOwnMessage = msg.sender === userName;
                    const isSystemMessage = msg.type === "system";
                    
                    if (isSystemMessage) {
                        msgElement.classList.add('system');
                    } else {
                        msgElement.classList.add(isOwnMessage ? 'self' : 'other');
                    }
                    
                    msgElement.innerHTML = `
                        ${!isSystemMessage ? `<div class="sender-name">${msg.sender}</div>` : ''}
                        <div class="message-text">${msg.message}</div>
                        <div class="message-time">${msg.displayTime || msg.timestamp}</div>
                        ${isOwnMessage ? '<div class="message-status">‚úì</div>' : ''}
                    `;
                    
                    chatMessagesDiv.appendChild(msgElement);
                });
                
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            };

            const updateTypingIndicator = (typingUsers) => {
                const existingIndicator = document.getElementById('typing-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                if (typingUsers.length > 0) {
                    const typingIndicator = document.createElement('div');
                    typingIndicator.id = 'typing-indicator';
                    typingIndicator.className = 'typing-indicator';
                    typingIndicator.innerHTML = `
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <div class="typing-text">${typingUsers[0]} est√° escribiendo...</div>
                    `;
                    chatMessagesDiv.appendChild(typingIndicator);
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                }
            };

            const sendMessage = async () => {
                const message = chatInput.value.trim();
                if (message === "") return;

                // Indicar que dej√≥ de escribir
                await updateTypingStatus(false);

                try {
                    const res = await fetch(`${API}/chat/${tripId}/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            sender: userName, 
                            message: message 
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (data.success) {
                        chatInput.value = '';
                        // Actualizar mensajes inmediatamente despu√©s de enviar
                        setTimeout(fetchMessages, 100);
                    } else {
                        showMessageError('Error al enviar mensaje');
                    }
                } catch (error) {
                    console.error('‚ùå Error de conexi√≥n al enviar mensaje:', error);
                    showMessageError('Error de conexi√≥n');
                }
            };

            const updateTypingStatus = async (typing) => {
                if (isTyping === typing) return;
                
                isTyping = typing;
                
                try {
                    await fetch(`${API}/chat/${tripId}/typing`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            sender: userName, 
                            isTyping: typing 
                        })
                    });
                } catch (error) {
                    // Silenciar errores de typing
                }
            };

            const handleTyping = () => {
                if (!isTyping) {
                    updateTypingStatus(true);
                }
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    updateTypingStatus(false);
                }, 1000);
            };

            const showMessageError = (message) => {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message-error';
                errorMsg.textContent = message;
                errorMsg.style.cssText = `
                    background: #ff4444;
                    color: white;
                    padding: 8px 12px;
                    border-radius: 10px;
                    margin: 5px 0;
                    text-align: center;
                    font-size: 0.8em;
                `;
                chatMessagesDiv.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);
            };

            // Configurar eventos
            sendChatBtn.onclick = sendMessage;
            
            chatInput.addEventListener('input', handleTyping);
            
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Agregar botones de mensajes r√°pidos
            addQuickReplies(tripId);

            // Cargar mensajes iniciales
            fetchMessages();
            
            // Polling m√°s eficiente
            if (currentChatInterval) clearInterval(currentChatInterval);
            currentChatInterval = setInterval(fetchMessages, 1500); // Actualizar cada 1.5 segundos
        }

        // Funci√≥n para agregar mensajes r√°pidos
        function addQuickReplies(tripId) {
            const quickReplies = [
                "¬øEn cu√°nto tiempo llegas?",
                "Estoy esperando en la entrada",
                "¬øPuedes llegar m√°s r√°pido?",
                "Gracias por el viaje",
                "Llegu√© bien, gracias"
            ];
            
            const quickRepliesContainer = document.createElement('div');
            quickRepliesContainer.className = 'quick-replies';
            
            quickReplies.forEach(reply => {
                const button = document.createElement('button');
                button.textContent = reply;
                button.className = 'quick-reply-btn';
                button.onclick = () => {
                    chatInput.value = reply;
                    sendChatBtn.click();
                };
                quickRepliesContainer.appendChild(button);
            });
            
            chatMessagesDiv.parentNode.insertBefore(quickRepliesContainer, chatMessagesDiv);
        }

        // Funci√≥n para mostrar notificaciones
        function showToast(message, success) {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.style.background = success ? 
                    "linear-gradient(135deg, #4CAF50, #45a049)" : 
                    "linear-gradient(135deg, #ff4444, #cc0000)";
                toast.classList.add("show");
                
                setTimeout(() => toast.classList.remove("show"), 4000);
            }
        }

        // Funci√≥n para reanudar viaje como pasajero - NUEVA
        async function resumePassengerTrip(tripId) {
            try {
                showToast('üîÑ Reanudando viaje activo...', true);
                
                const res = await fetch(`${API}/trips/${tripId}/status`, {
                    headers: {
                        'user-email': userEmail,
                        'session-id': sessionId
                    }
                });
                
                const data = await res.json();
                
                if (data.status === 'ACEPTADO') {
                    currentTripId = tripId;
                    
                    requestPanel.style.display = 'none'; 
                    activeTripPanel.style.display = 'block'; 
                    mapElement.classList.add('active'); 
                    
                    currentDriverName = data.driver;
                    document.getElementById('activeTripDriverName').innerText = currentDriverName;
                    
                    // Obtener detalles completos del viaje
                    const detailsRes = await fetch(`${API}/trips/${tripId}/details`, {
                        headers: {
                            'user-email': userEmail,
                            'session-id': sessionId
                        }
                    });
                    
                    const tripDetails = await detailsRes.json();
                    
                    document.getElementById('activeTripOriginDisplay').innerText = tripDetails.origen;
                    document.getElementById('activeTripDestinationDisplay').innerText = tripDetails.destino;
                    
                    // Verificar si el conductor es favorito
                    const favoriteBtn = document.getElementById('favoriteBtn');
                    const favoriteBadge = document.getElementById('favoriteBadge');
                    if (favoriteDrivers[currentDriverName]) {
                        favoriteBtn.style.color = 'var(--color-oro)';
                        favoriteBadge.style.display = 'inline';
                    }

                    shareLocationContainer.style.display = 'flex';
                    if (shareLocationBtn) {
                        shareLocationBtn.disabled = false;
                    }
                    updateMapEmbed();
                    startChatSession(currentTripId);
                    startDriverLocationPolling(currentTripId);
                    
                    showToast('‚úÖ Viaje reanudado correctamente', true);
                    
                } else {
                    showToast('‚ùå El viaje ya no est√° activo', false);
                    // Redirigir de vuelta al historial
                    setTimeout(() => {
                        window.location.href = `trip-history.html?sessionId=${sessionId}`;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Error reanudar viaje:', error);
                showToast('‚ùå Error al reanudar el viaje', false);
            }
        }

        // A√±adir funci√≥n para actualizar badge din√°mico
        async function updatePassengerAchievementBadge() {
            if (!userEmail) return;
            try {
                const res = await fetch(`${API}/profile/${userEmail}`);
                if (!res.ok) return;
                const data = await res.json();
                const badge = document.querySelector('.achievement-badge');
                if (badge && data.user && data.user.avgRating != null) {
                    badge.textContent = `‚≠ê ${parseFloat(data.user.avgRating).toFixed(1)}`;
                }
            } catch (err) {
                console.error('Error cargando rating pasajero:', err);
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadPassengerProfilePhoto();
            setupVoiceRecognition();
            // Reanudar viaje, historial, etc...
            // Actualizar badge con la calificaci√≥n real
            updatePassengerAchievementBadge();
            // ...existing code...
        });
    </script>
</body>
</html>